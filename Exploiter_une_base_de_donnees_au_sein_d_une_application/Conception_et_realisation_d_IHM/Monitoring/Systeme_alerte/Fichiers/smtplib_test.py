import smtplib, requests
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

def obtenir_metrique(nom_metrique):

    session = requests.Session()

    session.post('http://localhost:5000/dashboard/login', data = {'name' : 'admin', 'password' : 'admin'})

    url = f'http://localhost:5000/dashboard/api/{nom_metrique}'

    response = session.get(url, params = {'name' : 'admin', 'password' : 'admin'})

    if response.status_code == 200:
        data = response.json()['total_hits']
        return data
    else:
        print("Erreur lors de la récupération de la métrique:", response.text)

sender_email = 'antoinelecroart@gmail.com'
receiver_email = 'antoine.lecroart@neuf.fr'
subject = 'Métrique GET /allRapports'
message = f"Nombre de fois que cette route à été utilisée : {obtenir_metrique('endpoint_info/2')}"

smtp_server = 'smtp.gmail.com'
smtp_port = 587
smtp_username = 'antoinelecroart@gmail.com'
smtp_password = 'yawhxrkcgisffifs'

msg = MIMEMultipart()
msg['From'] = sender_email
msg['To'] = receiver_email
msg['Subject'] = subject
msg.attach(MIMEText(message, 'plain'))

server = smtplib.SMTP(smtp_server, smtp_port)
server.starttls()
server.login(smtp_username, smtp_password)
server.sendmail(sender_email, receiver_email, msg.as_string())
server.quit()
