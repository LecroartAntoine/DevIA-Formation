## Les grandes étapes de ce brief seront : 

### I. Installer docker  
  
### II. conteneuriser Jenkins (c'est à dire le faire tourner sur un conteneur docker plutot que sur le système de votre PC)  
  
### III. Faire un fork du dépot `simple-node-js-react-npm-app` : un projet existant basique basé sur NodeJS et REACT qui contient les fichiers minimalistes nécessaire au lancement d'une application REACT. Ce sera une base sûre pour s'entrainer sur le déploiement  
  
### IV. Lancer Jenkins et BlueOcean (Jenkins est l'application permettant d'exécuter les pipeline CI/CD, BlueOcean est un utilitaire pratique pour éditer de manière virtuelle les pipeline et de manière générale la gestion/monitoring des pipelines  
  
### V. Relier le dépôt GitHub à Jenkins pour que Jenkins puisse télécharger le dépot, être notifié d'un commit/push, mettre à jour le fichier de configuration JenkinFile, etc.  
  
### VI. Créer la pipeline avec les bonnes étapes pour l'installation, la construction et le déploiement de votre projet sur Firebase 
  
### VII. Créer l'environnement firebase qui hébergera votre application déployée  
  
### VIII. Finaliser votre pipeline en vérifiant son bon fonctionnement.  
  
### IX. Comprendre et restituer les étapes de ce brief pour en comprendre tous les détails  
  

### I. Installation de Docker : 
1. Installez docker sur votre machine (si vous ne l'avez pas déjà, sinon innutle de le faire) : https://docs.docker.com/get-docker/
2. Comprenez l'utilité et le fonctionnement de docker dans les grandes lignes : https://www.youtube.com/watch?v=caXHwYC3tq8

### II. Conteneuriser Jenkins
1. Suivre les étapes sur le tutoriel : https://www.jenkins.io/doc/tutorials/build-a-node-js-and-react-app-with-npm/#run-jenkins-in-docker
Ne faire que les premières étapes du tutoriel jusqu'à "Fork and clone the sample repository" (ne pas faire l'étape fork)

NB : pour l'étape où il faut créer le fichier Dockerfile, ce fichier doit être créé sur votre machine, et la ligne de commande suivant exécutée dans votre terminal, à l'endroit où vous avez créé ce fichier. 

### III. Faire un fork du dépot simple-node-js-react-npm-app
1. Rendez vous sur le dépot : https://github.com/jenkins-docs/simple-node-js-react-npm-app
2. Cliquer sur la flèche à côté de fork en haut à droite de l'écran
3. Cliquer sur créer un nouveau fork et hébergez le sur votre dépot PERSONNEL (pas sur snir2024)

### IV. Ouvrez Jenkins et BlueOcean 
Comme énoncé en introduction, BlueOcean est une amélioration de Jenkins permettant de créer, éditer et monitorer une pipeline CI/CD hébergée sur le serveur Jenkins. 
1. Ouvrez le serveur Jenkins (http://localhost:8080) et rendez-vous sur BlueOcean. 

### V. Relier le dépot GitHub 

1. dans BlueOceann, créez une première pipeline
2. Sélectionner GitHub
3. Cliquer sur Create an access token here
4. Nommez le nouveau jeton "Jenkins_blueocean"
5. Ajoutez `admin:org_hook` dans les droits pour permettre à Jenkins d'être notifié à chaque commit/push
6. Réglez `no expiration` pour la durée de validité
7. Copiez le jeton, collez le dans BlueOcean et gardez le bien précieusement. Il sera nécessaire pour la suite du brief et est supprimé une fois la page GitHub fermée. 
8. Sélectionnez le dépôt `simple-node-js-react-npm-app` dans votre espace personnel
9. Créez la pipeline
10. Une fois créée, un message vous indique qu'aucun fichier Jenkinsfile n'a été trouvé. C'est normal car votre dépôt n'en contient effectivement pas. Ce fichier sera créé lors du premier enregistrement de votre pipeline. C'est dans ce fichier que seront stockées les étapes de la pipeline. 
11. Dans l'étape start, mettez les informations suivantes :

`- Agent : docker => on utilisera un conteneur docker pour exécuter la pipeline
- Image : node:18.17.1-alpine3.18 => L'image du conteneur
- Args : -p 3000:3000 => les ports (externe 
`

12. Ajouter une étape « welcome » 
    1. Add action 
    2. Shell script
    3. `echo "coucou"`
    4. Lancer la pipeline et vérifier le bon fonctionnement
    5. Vérifier dans votre dépôt GitHub qu’un fichier Jenkinsfile a été créé à la racine et qu’il est complété avec ce que vous avez déjà rajouté.
   
13. Configurer le plugin GitHub qui permettra de gérer le déclenchement de la pipeline
    1. Allez dans manage Jenkins / System
    2. GitHub => ajouter un serveur 
    3. Credentials / add credentials / Jenkins
    4. Type => secret text
    5. Dans secret, coller le token précédemment sauvegardé
    6. Sélectionner le nouveau credential dans la liste 
    7. Test connexion
    8. Cocher la case "manage hooks"
   
### VI. Créer et paramétrer toutes les étapes de la pipeline
   
1. Rajouter dans la pipeline l’étape : `installer`
    1. Script shell => `npm install`
    2. Lancer et vérifier la sortie 
2. Rajouter dans la pipeline l’étape `build`
    1. Script shell => `npm run build`
    2. Lancer et vérifier la pipeline
3. Rajouter dans la pipeline l’étape `Deploy`


### VII. Paramétrer Firebase pour le déploiement 

Pour l’étape déploiement, il faut que firebase soit initialisé sur un nouveau projet

1. Connectez vous à votre compte Firebase
2. Créer un nouveau projet
3. Aller dans hosting
4. Cliquez sur commencer

L'assistant vous donne la ligne de commande pour installer la CLI Firebase. Cette commande utilise npm et ne fonctionnera pas sur le conteneur docker car le niveau de sécurité requis n'est pas atteignable sans modification en profondeur du conteneur. Pour installer la CLI firebase, on va donc passer par yarn qui est un autre utilitaire d'instalation de paquets nécessitant moins de sécurité. 

5. Rajouter `yarn global add firebase-tools` dans l'étape `deploy` de la pipeline. Cette commande est l’équivalent de la commande proposée par firebase `npm install -g firebase-tools`

Pour l’étape de login et de déploiement sur Firebase (deux dernières étapes) on ne peut pas utiliser les commandes fournies car notre pipeline est en mode non interactif c'est à dire que les lignes de commande s'exécuteront sans interraction avec un terminal. On doit donc utiliser un jeton (token) et des commandes spécifiques
       
6. Cliquer sur accéder à la console

Avec un projet firebase, on peut créer plusieurs sites. Par exemple pour un projet pluviomètres connectés, on pourrait avoir un site pour la gestion client, un site pour la gestion administrative, technique, un site pour la promotion commerciale, etc. 

7. Dans hosting, aller tout en bas sur « ajouter un site »
8. Nommez le (par ex : `briefcicdnomprenom` => pas de majuscules, ni caractères spéciaux, NOM ET PRENOM OBLIGATOIRE DANS LE NOM DU PROJET)
9. Cliquer sur le site créé (cliquer sur « lecteur » )
10. Cliquer sur « Instructions »


11. Initialiser votre projet : `firebase login:ci` (on rajoute "ci" pour indiquer que l’on va fonctionner avec un système sans tête) dans un terminal et récupérer le jeton donné. Gardez-le. 

Pour rappel, l'obtention du jeton est obligatoire pour pouvoir effectuer les commandes de déploiment dans un système non interractif. En effet, la procédure normale implique un dialogue avec firebase via la commande "firebase login" dans un terminal mais dans la pipeline avec exécution automatique, ce dialogue n'est pas possible. 

12. Dans la section « Déployer sur Firebase Hosting » notez le nom de votre projet
13. Récupérez le fichier firebase.json dans les fichiers du brief et remplacez le nom du site par le votre
14. Mettez ce fichier à la racine de votre projet

Nb : la ligne de commande qui permet d’effectuer le déploiement de votre application donnée par firebase n'est pas exactement celle que nous allons utiliser mais la base reste la même. 

### VIII. Finaliser la pipeline 

1. Rajouter le jeton en variable d’environnement de votre pipeline : 
            1. Aller dans la pipeline blueocean
            2. Sur l’étape de démarrage (start) à droite cliquer sur + sous environnement
            3. Nommez la variable `FIREBASE_TOKEN` et collez le token obtenu après firebase `login:ci `
            4. Dans l’étape « `deploy` », complétez le script shell par :

```echo FIREBASE_TOKEN```  

2. Rajoutez ```export PATH="$(yarn global bin):$PATH"``` pour spécifier que l’on peut utiliser les paquets installés par yarn dans le système global
            1. lancer la pipeline pour vérifier que tout fonctionne et que le token firebase s’affiche bien
            2. Ajoutez à la fin : ```firebase deploy --only hosting:idsite --project idprojet --token $FIREBASE_TOKEN```
            Attention, mettre l’ID du projet et non le nom. A trouver dans paramètres du projet sur firebase console. 
            3. Enregistrez et Lancez la pipelie pour vérifier que tout se passe bien. 
            4. Consultez le site publique de votre projet (vous trouverez dans les sites sur hosting)

Félicitations, l'ensemble de la pipeline est créée et fonctionnelle ! Bien sûr on peut l'enrichir, la modifier ... 

GitHub fonctionne avec le système des webHook c’est à dire que dès que l’on fait un commit / push, GitHub va envoyer une notification à la pipeline pour qu’elle la déclenche. Cela se fait : 

- Soit on enregistre l’adresse publique de la pipeline sur GitHub 
- Soit jenkins se charge de faire l’enregistrement auprès de GitHub

Tout cela se passe dans la configuration du plugin et de la pipeline mais comme on exécute jenkins sur un serveur localhost, il n'y a pas d’adresse publique et donc on ne peut pas utiliser ce procédé. La solution est d'héberger jenkins sur un serveur publique (type AWS ou Azure) pour avoir une adresse publique. 

### IX. Comprendre et restituer les étapes du brief 

Reprendre chaque étape depuis le début pour bien comprendre tout l'enchainement de ce que vous avez fait. 
Exercice : être capable d'expliquer à voix haute, sans support, tout ce que vous avez dû faire pour mettre en place ce système CI/CD




